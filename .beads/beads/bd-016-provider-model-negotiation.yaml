id: bd-016
type: task
title: P1 - Provider model negotiation (configured vs selected model)
description: |
  Make providers “negotiate” for the best model they can serve, guided by the
  Arbiter recommended model catalog.

  Requirements
  - Extend provider state to track:
    - configured_model (requested / preferred)
    - selected_model (effective)
    - selection_reason (why this model was chosen)
    - optional selected_gpu (if provider supports GPU selection)
  - Add a negotiation routine that:
    1) calls provider’s OpenAI-compatible `/models`
    2) intersects discovered models with Arbiter recommended catalog
    3) ranks candidates by Arbiter scoring (initial scoring can be heuristic)
    4) writes back selected_model and reason into provider state
  - Run negotiation:
    - on provider create/update
    - and via an explicit API trigger (e.g., POST /api/v1/providers/{id}/negotiate)

  Fallback behavior
  - If no recommended model matches:
    - use configured_model if present and available
    - else pick the best discovered model by heuristic
  - Always store a reason in provider context.

  Acceptance Criteria
  - Provider shows configured_model vs selected_model.
  - Negotiation selects a recommended model when available.
  - API trigger causes an immediate re-evaluation.

status: closed
priority: 1
project_id: arbiter
assigned_to: null
blocked_by:
  - bd-015
blocks: []
parent: bd-014
children: []
tags:
  - p1
  - providers
  - negotiation
  - models
created_at: 2026-01-19T08:26:00Z
updated_at: 2026-01-19T11:10:00Z
closed_at: 2026-01-19T11:10:00Z
context:
  source: user-request
