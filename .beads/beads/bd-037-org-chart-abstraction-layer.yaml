id: bd-037
type: task
title: P0 - Org Chart Abstraction Layer for Project-Agent Association
description: |
  When a project is first registered (e.g., via bootstrap or API), the system
  currently spawns default agents but lacks a proper abstraction for the
  "org chart" - the set of agents assigned to work on a project.

  Problem Statement
  - Projects are created without a formalized org chart structure
  - Agents are directly associated to projects via a simple []string Agents field
  - No concept of "default org chart" that every new project should receive
  - No hierarchy support for sub-projects inheriting or overriding org charts
  - No clean separation between "role slots" and "agent instances filling them"

  Proposed Abstraction: OrgChart
  
  An OrgChart is a new model that sits between Project and Agent:
  
  ```go
  // OrgChart defines the agent team structure for a project
  type OrgChart struct {
      ID          string            `json:"id"`
      ProjectID   string            `json:"project_id"`
      Name        string            `json:"name"`           // e.g., "Default", "Custom"
      Positions   []Position        `json:"positions"`      // Role slots in the org
      IsTemplate  bool              `json:"is_template"`    // If true, this is a template
      ParentID    string            `json:"parent_id"`      // For inherited org charts
      CreatedAt   time.Time         `json:"created_at"`
      UpdatedAt   time.Time         `json:"updated_at"`
  }

  // Position represents a role slot in an org chart
  type Position struct {
      ID           string   `json:"id"`
      RoleName     string   `json:"role_name"`       // e.g., "ceo", "product-manager"
      PersonaPath  string   `json:"persona_path"`    // e.g., "default/ceo"
      Required     bool     `json:"required"`        // Must be filled
      MaxInstances int      `json:"max_instances"`   // 0 = unlimited
      AgentIDs     []string `json:"agent_ids"`       // Currently assigned agents
      ReportsTo    string   `json:"reports_to"`      // Position ID of manager
  }
  ```

  Hierarchy Model
  - Default OrgChart Template: System-wide template with all default roles
  - Project OrgChart: Instance created for each project, initially cloned from template
  - Sub-Project OrgChart: Can inherit from parent project or use custom structure

  Project Hierarchy
  - Projects can have sub-projects (ParentID on Project model)
  - Sub-projects can inherit org chart from parent or define their own
  - Agents can be shared across project hierarchy or scoped to specific level

  Agent Instance Model
  - Agent = instance of a persona working on a specific project
  - Each agent fills one or more positions in an org chart
  - Persona = Job Description (what the role does)
  - Agent = Person in the role (specific instance with state)

  Bootstrap Flow Changes
  1. System defines DefaultOrgChartTemplate on startup
  2. CreateProject() creates a new OrgChart cloned from template
  3. ensureDefaultAgents() becomes ensureOrgChart() - fills required positions
  4. Agents are spawned to fill positions, not just "added to project"

  API Changes
  - GET /api/projects/{id}/org-chart - Get project's org chart
  - PUT /api/projects/{id}/org-chart - Update org chart structure
  - POST /api/projects/{id}/org-chart/positions - Add position
  - DELETE /api/projects/{id}/org-chart/positions/{posId} - Remove position
  - POST /api/projects/{id}/org-chart/positions/{posId}/assign - Assign agent
  - DELETE /api/projects/{id}/org-chart/positions/{posId}/agents/{agentId} - Unassign

  Database Changes
  - New table: org_charts
  - New table: org_chart_positions
  - Add parent_id to projects table for sub-project support

  Migration Path
  - Existing projects get org chart created from their current Agents list
  - Existing agents mapped to positions based on persona name

  Acceptance Criteria
  - [x] OrgChart and Position models defined in pkg/models
  - [x] OrgChartManager created in internal/orgchart
  - [x] Default org chart template defined from personas/default/* roles
  - [x] Project.CreateProject() creates org chart from template
  - [ ] Sub-project support with parent_id on Project model
  - [x] API endpoints for org chart CRUD (GET /api/v1/org-charts/{projectId})
  - [ ] Database schema for org charts and positions
  - [ ] Migration for existing projects/agents
  - [ ] UI shows org chart structure in project view
  - [x] Tests for org chart operations

status: in_progress
priority: 0
project_id: agenticorp
assigned_to: null
blocked_by: []
blocks: []
parent: null
children: []
tags:
  - p0
  - org-chart
  - projects
  - agents
  - architecture
  - bootstrap
created_at: 2026-01-20T03:45:00Z
updated_at: 2026-01-20T03:45:00Z
context:
  source: user-request
  rationale: |
    When AgentiCorp self-registers on startup, it creates a project but the
    concept of "org chart" (the team of agents assigned to work on it) is
    implicit and scattered. This P0 formalizes that abstraction layer to
    enable proper project bootstrapping, sub-project hierarchies, and
    clear separation between role definitions and agent instances.
